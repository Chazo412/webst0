{% extends "base.html" %}
{% load static %}
{% block conversionactive %} active {% endblock conversionactive %}
{% block title %} Conversion {% endblock title %}
{% block body %}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <meta name="description" content="Your description here">
    <meta name="author" content="Your Name">
    <meta name="robots" content="index, follow">

    <!-- Cache control meta tags to prevent caching -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">

    <!-- Cache-busting for CSS and JavaScript files -->
    <link rel="stylesheet" type="text/css" href="{% static 'css/style.css' %}?v=1">
    
    <title>Conversion</title>
</head>
<body>

    <div class="container-fluid margin-container" style="padding-top: 120px;">
    <link rel="stylesheet" type="text/css" href="{% static 'css/style.css' %}">
    
    <div class="container-fluid margin-container" style="padding-top: 120px;">
        <h2 style="text-align: center; margin-bottom: 0; padding: 20px;">Upload Audio File</h2>
        
    <!-- File Drop Container -->
    <div id="file-drop-container" class="file-drop-container">
        <h4>Drop your audio here</h4>
        <p id="drag-text">Drag and drop your audio file here</p>
    </div>

    <!-- Upload Trigger Button -->
    <button id="trigger-upload-button" class="btn btn-success custom-button0">Upload File</button>

    
        <!--Javascript code for file-drop-container-->
        <script>
            document.addEventListener("DOMContentLoaded", function () {
                const fileDropContainer = document.getElementById("file-drop-container");
                let droppedFile = null;

                fileDropContainer.addEventListener("dragover", (e) => {
                    e.preventDefault();
                    fileDropContainer.classList.add("drag-over");
                });

                fileDropContainer.addEventListener("dragleave", () => {
                    fileDropContainer.classList.remove("drag-over");
                });

                fileDropContainer.addEventListener("drop", (e) => {
                    e.preventDefault();
                    fileDropContainer.classList.remove("drag-over");
                    e.dataTransfer.dropEffect = "copy";

                    const files = e.dataTransfer.files;
                    if (files.length > 0) {
                        droppedFile = files[0];
                        fileDropContainer.innerHTML = `<h4>File selected: ${droppedFile.name}</h4>`;
                    }
                });

                const triggerUploadButton = document.getElementById("trigger-upload-button");

        triggerUploadButton.addEventListener("click", async () => {
            if (droppedFile) {
                const formData = new FormData();
                formData.append("audio_file", droppedFile);

                try {
                    const response = await fetch("{% url 'dropUpload' %}", {
                        method: "POST",
                        body: formData,
                    });

                            if (response.ok) {
                                console.log("File uploaded successfully");
                                fileDropContainer.innerHTML = `<h4>Upload successful: ${droppedFile.name}</h4>`;
                                droppedFile = null;
                                uploadButton.style.display = "none";
                            } else {
                                console.error("File upload failed");
                            }
                            } catch (error) {
                                console.error("Fetch error:", error);
                                }
                        }
                    });
                });

        </script>
        
    
        <div id="error-message" class="errors" style="display: none;"></div>
    
        <div><h1 style="text-align: center">OR</h1></div>
    </div>
    



        <!-- YouTube 2 MP3 Converter Form -->
        {% if not success_convert %}
        <form action="{% url 'convert_mp3' %}" method="POST" id="form">
            {% csrf_token %}
            <h1><i class="fab fa-youtube"></i> Enter the Youtube URL</h1>
            <div>
                <input type="text" name="video_id" placeholder="Youtube URL"><button id="submit-btn">Convert</button>
            </div>
        </form>
        {% endif %}

        <!-- Response Display -->
        <div class="bottom-container">
            {% if success is not None %}
                {% if success %}
                    <div class="success">
                        <p>{{ song_title }}</p>
                        <p>File Size: {% if file_size_mb %}{{ file_size_mb|floatformat:2 }} MB{% else %}N/A{% endif %}</p>
                        <a href="{{ song_link }}"><button id="download-btn">DOWNLOAD</button></a>
                    </div>
                {% else %}
                    <div class="errors">
                        <p>{{ message }}</p>
                    </div>
                {% endif %}
            {% endif %}
        </div>

        <div class="container-fluid" style="padding-top: 70px;"></div>
        <h2>Select Your Ai</h2>
        <select class="form-select">
            <option value="file1">Spongebob</option>
            <option value="file2">Patrick</option>
            <option value="file3">Squidward</option>
            <option value="file4">Plankton</option>
            <option value="file5">Mr.Krabs</option>
            <option value="file6">Madea</option>
            <!-- Add more options as needed -->
        </select>

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const form = document.getElementById("form");
            const submitButton = document.getElementById("submit-btn");
            const errorMessage = document.getElementById("error-message");

            form.addEventListener("submit", function (event) {
                const videoIdInput = document.querySelector("input[name='video_id']");

                if (!videoIdInput.value.trim()) {
                    event.preventDefault();
                    errorMessage.textContent = "Please enter a YouTube link";
                    errorMessage.style.display = "block";
                } else {
                    errorMessage.style.display = "none";
                }
            });
        });
    </script>

    </div>
</body>
</html>
{% endblock body %}
